---
- name: Configuration Jenkins Master
  hosts: jenkins
  become: true
  vars:
    jenkins_admin_username: "{{ lookup('env', 'JENKINS_ADMIN_USERNAME') }}"
    jenkins_admin_password: "{{ lookup('env', 'JENKINS_ADMIN_PASSWORD') }}"
    jenkins_http_port: 8080
    jenkins_java_options: "-Djenkins.install.runSetupWizard=false"
  vars_files:
    - vars/jenkins.yml

  tasks:
    # Fix Docker APT avant tout
    - name: Fix Docker APT
      script: ../../scripts/fix_docker_apt.sh

    # Installation base
    - name: Install base packages
      apt:
        name:
          - openjdk-17-jdk
          - curl
          - wget
          - git
          - unzip
          - jq
          - python3-pip
          - build-essential
        update_cache: yes

    - name: Set timezone
      timezone:
        name: Europe/Paris

    # Jenkins via roles
    - name: Install Jenkins role
      shell: ansible-galaxy install geerlingguy.java geerlingguy.jenkins --force
      delegate_to: localhost
      run_once: true

    # Node.js
    - name: Setup Node.js
      block:
        - name: Create Node.js directory
          file:
            path: /opt/nodejs
            state: directory

        - name: Download and extract Node.js
          unarchive:
            src: https://nodejs.org/dist/v18.19.0/node-v18.19.0-linux-x64.tar.xz
            dest: /opt/nodejs
            remote_src: yes
            extra_opts: [--strip-components=1]
            creates: /opt/nodejs/bin/node

        - name: Create Node.js symlinks
          file:
            src: "/opt/nodejs/bin/{{ item }}"
            dest: "/usr/local/bin/{{ item }}"
            state: link
          loop: [node, npm, npx]

    # Docker
    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        update_cache: yes

    - name: Start Docker and add jenkins user
      block:
        - name: Start Docker
          systemd:
            name: docker
            state: started
            enabled: yes

        - name: Add jenkins to docker group
          user:
            name: jenkins
            groups: docker
            append: yes

    # AWS CLI
    - name: Install AWS CLI
      block:
        - name: Download AWS CLI
          get_url:
            url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
            dest: /tmp/awscliv2.zip

        - name: Install AWS CLI
          unarchive:
            src: /tmp/awscliv2.zip
            dest: /tmp
            remote_src: yes
          notify: install_aws_cli

    # Terraform
    - name: Install Terraform
      unarchive:
        src: https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip
        dest: /usr/local/bin
        remote_src: yes
        mode: '0755'
        creates: /usr/local/bin/terraform

  roles:
    - geerlingguy.java
    - geerlingguy.jenkins

  handlers:
    - name: install_aws_cli
      command: /tmp/aws/install
      args:
        creates: /usr/local/bin/aws

  post_tasks:
    - name: Restart Jenkins
      systemd:
        name: jenkins
        state: restarted

    - name: Wait for Jenkins
      uri:
        url: http://localhost:{{ jenkins_http_port }}
        status_code: 200
      retries: 30
      delay: 10
