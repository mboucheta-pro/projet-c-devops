---
- name: Configuration SonarQube
  hosts: sonarqube
  become: true
  vars:
    sonarqube_admin_password: "{{ lookup('env', 'SONARQUBE_ADMIN_PASSWORD') }}"
    sonarqube_admin_username: "{{ lookup('env', 'SONARQUBE_ADMIN_USERNAME') }}"
  
  tasks:
    # Fix Docker APT (coh√©rent avec les autres)
    - name: Fix Docker APT
      script: ../../scripts/fix_docker_apt.sh

    # Installation base
    - name: Install base packages
      apt:
        name:
          - python3-pip
          - jq
          - curl
          - wget
          - git
        update_cache: yes

    - name: Set timezone
      timezone:
        name: Europe/Paris

    # Docker (m√™me m√©thode que Jenkins)
    - name: Install Docker
      shell: |
        apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      timeout: 300
      retries: 2
      delay: 10

    - name: Setup Docker
      block:
        - name: Start Docker
          systemd:
            name: docker
            state: started
            enabled: yes

        - name: Add ubuntu to docker group
          user:
            name: ubuntu
            groups: docker
            append: yes

    # SonarQube via Docker Compose
    - name: Setup SonarQube
      block:
        - name: Copy docker-compose file
          copy:
            src: "../files/sq-docker-compose.yml"
            dest: /home/ubuntu/docker-compose.yml
            owner: ubuntu
            group: ubuntu

        - name: Start SonarQube
          shell: docker-compose -f /home/ubuntu/docker-compose.yml up -d
          args:
            chdir: /home/ubuntu
          become_user: ubuntu

        - name: Wait for SonarQube
          uri:
            url: "http://localhost:9000/api/system/status"
          retries: 30
          delay: 10

    - name: Change SonarQube admin password (si diff√©rent de admin)
      uri:
        url: "http://localhost:9000/api/users/change_password"
        method: POST
        user: "admin"
        password: "admin"
        body_format: form-urlencoded
        body:
          login: "admin"
          previousPassword: "admin"
          password: "{{ sonarqube_admin_password | default('admin') }}"
        status_code: 204
      register: change_admin_pw
      failed_when: change_admin_pw.status not in [204, 400, 401]
      ignore_errors: true

    - name: Debug SonarQube password change result
      debug:
        msg: |
          {% if change_admin_pw.status == 204 %}
            ‚úÖ SonarQube admin password changed successfully.
          {% elif change_admin_pw.status == 401 %}
            ‚ö†Ô∏è  SonarQube admin password was already changed or is not 'admin'. Skipping password change.
          {% elif change_admin_pw.status == 400 %}
            ‚ö†Ô∏è  SonarQube password change request was invalid (possibly already set to this password).
          {% else %}
            ‚ùå Unexpected status: {{ change_admin_pw.status }}
          {% endif %}
      when: change_admin_pw is defined

    - name: Affiche les infos SonarQube
      debug:
        msg:
          - "‚úÖ SonarQube ready at http://{{ inventory_hostname }}:9000"
          - "üîë Credentials admin : {{ sonarqube_admin_username | default('admin') }}/{{ sonarqube_admin_password | default('admin') }}"
