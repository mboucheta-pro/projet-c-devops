---
- name: Configuration de SonarQube
  hosts: sonarqube
  become: true
  vars:
    sonarqube_admin_password: "{{ lookup('env', 'SONARQUBE_ADMIN_PASSWORD') }}"
    sonarqube_admin_username: "{{ lookup('env', 'SONARQUBE_ADMIN_USERNAME') }}"
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Activer NTP avec timedatectl
      become: yes
      ansible.builtin.command: timedatectl set-ntp true
      changed_when: false

    - name: Configurer la timezone sur Europe/Paris
      timezone:
        name: Europe/Paris

    - name: Install Docker and dependencies
      apt:
        name: 
          - docker.io
          - docker-compose
          - python3-pip
          - python3-setuptools
          - python3-venv
          - pipx
          - jq
          - curl
        state: present
        update_cache: yes

    - name: Start Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Copy docker-compose file
      copy:
        src: "../files/sq-docker-compose.yml"
        dest: /home/ubuntu/docker-compose.yml
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Start SonarQube with docker-compose
      shell: docker-compose -f /home/ubuntu/docker-compose.yml up -d
      args:
        chdir: /home/ubuntu
      become_user: ubuntu

    - name: Wait for SonarQube to be ready
      uri:
        url: "http://localhost:9000/api/system/status"
        method: GET
      register: sonar_status
      until: sonar_status.status == 200
      retries: 30
      delay: 10
      
    - name: Pause pour permettre à SonarQube de s'initialiser complètement
      pause:
        seconds: 30
        prompt: "Attente de 30 secondes pour que SonarQube s'initialise complètement..."
      
    - name: Créer un script pour configurer SonarQube (token, webhook)
      copy:
        content: |
          #!/bin/bash
          
          # Variables
          SONAR_URL="http://localhost:9000"
          SONAR_ADMIN_USER="{{ sonarqube_admin_username | default('admin') }}"
          SONAR_ADMIN_PASS="{{ sonarqube_admin_password | default('admin') }}"
          JENKINS_URL="http://{{ lookup('env', 'JENKINS_IP') | default('localhost') }}:8080"
          
          # Attendre que SonarQube soit complètement démarré
          echo "Attente du démarrage complet de SonarQube..."
          for i in {1..12}; do
            STATUS_RESPONSE=$(curl -s -u "${SONAR_ADMIN_USER}:${SONAR_ADMIN_PASS}" "${SONAR_URL}/api/system/status")
            echo "État de SonarQube: $STATUS_RESPONSE"
            if echo "$STATUS_RESPONSE" | grep -q '"status":"UP"'; then
              echo "SonarQube est prêt!"
              break
            fi
            echo "SonarQube n'est pas encore prêt, nouvelle tentative dans 10 secondes... ($i/12)"
            sleep 10
          done
          
          # Attendre 10 secondes supplémentaires pour être sûr que tous les services sont opérationnels
          echo "Attente supplémentaire pour s'assurer que tous les services SonarQube sont opérationnels..."
          sleep 10
          
          # Changer le mot de passe administrateur si c'est la première installation
          if [ "$SONAR_ADMIN_USER" = "admin" ] && [ "$SONAR_ADMIN_PASS" != "admin" ]; then
            echo "Changement du mot de passe administrateur par défaut..."
            curl -s -X POST -u "admin:admin" "${SONAR_URL}/api/users/change_password" \
              -d "login=admin&previousPassword=admin&password=${SONAR_ADMIN_PASS}"
          fi
          
          # Créer un token d'API pour Jenkins
          echo "Création d'un token d'API pour Jenkins..."
          # Ajouter un délai pour s'assurer que SonarQube est complètement initialisé
          sleep 10
          
          # Vérifier si un token jenkins-token existe déjà et le révoquer
          echo "Vérification des tokens existants..."
          EXISTING_TOKENS=$(curl -s -u "${SONAR_ADMIN_USER}:${SONAR_ADMIN_PASS}" \
            "${SONAR_URL}/api/user_tokens/search")
          echo "Tokens existants: $EXISTING_TOKENS"
          
          # Révoquer le token jenkins-token s'il existe
          if echo "$EXISTING_TOKENS" | grep -q "jenkins-token"; then
            echo "Révocation du token jenkins-token existant..."
            curl -s -X POST -u "${SONAR_ADMIN_USER}:${SONAR_ADMIN_PASS}" \
              "${SONAR_URL}/api/user_tokens/revoke" \
              -d "name=jenkins-token"
          fi
          
          # Génération du nouveau token avec plus d'informations de débogage
          echo "Génération du nouveau token..."
          TOKEN_RESPONSE=$(curl -v -X POST -u "${SONAR_ADMIN_USER}:${SONAR_ADMIN_PASS}" \
            "${SONAR_URL}/api/user_tokens/generate" \
            -d "name=jenkins-token")
          
          echo "Réponse complète: $TOKEN_RESPONSE"
          TOKEN=$(echo $TOKEN_RESPONSE | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
          
          if [ -n "$TOKEN" ]; then
            echo "Token SonarQube créé avec succès: $TOKEN"
            
            # Vérifier si aws cli est disponible, sinon utiliser la sortie standard
            if command -v aws >/dev/null 2>&1; then
              echo "Mise à jour du secret dans AWS Secrets Manager..."
            
            # Récupérer le secret existant
            EXISTING_SECRET=$(aws secretsmanager get-secret-value \
              --secret-id projet-c-devops-sonarqube-credentials \
              --region ca-central-1 \
              --query SecretString \
              --output text 2>/dev/null)
              
              if [ $? -eq 0 ] && [ -n "$EXISTING_SECRET" ]; then
                # Ajouter le token au secret existant si jq est disponible
                if command -v jq >/dev/null 2>&1; then
                  UPDATED_SECRET=$(echo $EXISTING_SECRET | jq --arg token "$TOKEN" '. + {token: $token}')
                  
                  # Mettre à jour le secret
                  aws secretsmanager update-secret --secret-id projet-c-devops-sonarqube-credentials \
                    --secret-string "$UPDATED_SECRET" \
                    --region ca-central-1
                else
                  echo "jq n'est pas installé, impossible de mettre à jour le secret proprement"
                  echo "Token SonarQube: $TOKEN"
                  # Créer une simple chaîne JSON
                  SIMPLE_JSON="{\"admin_username\":\"${SONAR_ADMIN_USER}\",\"admin_password\":\"${SONAR_ADMIN_PASS}\",\"token\":\"${TOKEN}\"}"
                  aws secretsmanager update-secret --secret-id projet-c-devops-sonarqube-credentials \
                    --secret-string "$SIMPLE_JSON" \
                    --region ca-central-1
                fi
              else
                echo "Impossible de récupérer le secret existant ou secret vide"
                echo "Token SonarQube: $TOKEN"
                echo "Veuillez mettre à jour manuellement le secret dans AWS Secrets Manager"
              fi
            else
              echo "AWS CLI n'est pas disponible, voici le token pour l'utiliser manuellement:"
              echo "Token SonarQube: $TOKEN"
              echo "Veuillez mettre à jour manuellement le secret dans AWS Secrets Manager"
            fi
          else
            echo "Échec de la création du token SonarQube"
          fi
          
          # Configurer un webhook pour Jenkins
          echo "Configuration d'un webhook SonarQube pour Jenkins..."
          
          # Vérifier les webhooks existants
          EXISTING_WEBHOOKS=$(curl -s -u "${SONAR_ADMIN_USER}:${SONAR_ADMIN_PASS}" \
            "${SONAR_URL}/api/webhooks/list")
          
          echo "Webhooks existants: $EXISTING_WEBHOOKS"
          
          # Supprimer le webhook Jenkins s'il existe déjà
          if echo "$EXISTING_WEBHOOKS" | grep -q "Jenkins"; then
            WEBHOOK_KEY=$(echo "$EXISTING_WEBHOOKS" | grep -o '"key":"[^"]*","name":"Jenkins"' | cut -d'"' -f4)
            if [ -n "$WEBHOOK_KEY" ]; then
              echo "Suppression du webhook Jenkins existant..."
              curl -s -X POST -u "${SONAR_ADMIN_USER}:${SONAR_ADMIN_PASS}" \
                "${SONAR_URL}/api/webhooks/delete" \
                -d "webhook=${WEBHOOK_KEY}"
            fi
          fi
          
          # Créer le webhook
          WEBHOOK_RESPONSE=$(curl -v -X POST -u "${SONAR_ADMIN_USER}:${SONAR_ADMIN_PASS}" \
            "${SONAR_URL}/api/webhooks/create" \
            -d "name=Jenkins&url=${JENKINS_URL}/sonarqube-webhook/")
          
          echo "Réponse webhook: $WEBHOOK_RESPONSE"
          
          echo "Configuration de SonarQube terminée"
        dest: /tmp/configure-sonarqube.sh
        mode: '0755'
      
    - name: Installer AWS CLI pour la mise à jour des secrets
      apt:
        name: "{{ item }}"
        state: present
        update_cache: yes
      with_items:
        - unzip
        - curl
      
    - name: Télécharger AWS CLI v2
      get_url:
        url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
        dest: /tmp/awscliv2.zip
        mode: '0644'
      
    - name: Extraire AWS CLI v2
      unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp
        remote_src: yes
        creates: /tmp/aws
      
    - name: Installer AWS CLI v2
      command: /tmp/aws/install
      args:
        creates: /usr/local/bin/aws
      register: pip_aws_result
      ignore_errors: yes
      
    - name: Exécuter le script de configuration SonarQube
      shell: /tmp/configure-sonarqube.sh
      environment:
        AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') | default('') }}"
        AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') | default('') }}"
        AWS_DEFAULT_REGION: "ca-central-1"
      become: false
      register: configure_sonarqube_result
      
    - name: Afficher les résultats de la configuration
      debug:
        msg: "Configuration SonarQube terminée: {{ configure_sonarqube_result.stdout_lines }}"